const express = require("express");
const { Server } = require("socket.io");
const cors = require("cors");
const app = express();
const http = require("http");
const setObjectif = require("./setobjectif");
const StoreData = require("./storeData");
const sendProgress = require("./sendProgress")

//let time = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100];
//let Velocity = [0, 5, 20, 30, 40, 50, 60, 70, 80, 90, 100];

let time = [
    0, 10, 30, 50, 60, 80, 100, 120, 130, 150, 170, 190, 200, 220, 240, 260,
    270, 290, 310, 330, 340, 360, 380, 400, 410, 430, 450, 470, 490, 500, 520,
    540, 560, 570, 590, 610, 630, 640, 660, 680, 700, 710, 730, 750, 770, 780,
    800, 820, 840, 850, 870, 890, 910, 920, 940, 960, 980, 1000, 1010, 1030,
    1050, 1070, 1080, 1100, 1120, 1140, 1150, 1170, 1190, 1210, 1220, 1240,
    1260, 1280, 1290, 1310, 1330, 1350, 1360, 1380, 1400, 1420, 1430, 1450,
    1470, 1490, 1500, 1520, 1540, 1560, 1570, 1590, 1610, 1630, 1650, 1660,
    1680, 1700, 1720, 1730, 1750, 1770, 1790, 1800, 1820, 1840, 1860, 1870,
    1890, 1910, 1930, 1940, 1960, 1980, 2000, 2010, 2030, 2050, 2070, 2080,
    2100, 2120.01, 2140.01, 2150.01, 2170.01, 2190.01, 2210.01, 2220.01,
    2240.01, 2260.01, 2280.01, 2290.01, 2310.01, 2330.01, 2350.01, 2360.01,
    2380.01, 2400.01, 2420.01, 2440.01, 2450.01, 2470.01, 2490.01, 2510.01,
    2520.01, 2540.02, 2560.02, 2580.02, 2590.02, 2610.02, 2630.02, 2650.02,
    2660.02, 2680.02, 2700.02, 2720.02, 2730.02, 2750.02, 2770.02, 2790.02,
    2800.02, 2820.02, 2840.02, 2860.02, 2870.02, 2890.02, 2910.02, 2930.02,
    2940.02, 2960.02
];
let Velocity = [
    0, 0.7, 2.79, 5.57, 6.27, 9.75, 11.84, 14.62, 14.62, 17.41, 20.19, 23.67,
    24.37, 27.85, 29.94, 31.33, 33.42, 34.81, 36.21, 38.3, 39.69, 41.78, 43.87,
    46.65, 48.04, 48.74, 50.13, 51.52, 53.61, 55.01, 56.4, 58.49, 59.88, 59.88,
    61.97, 63.36, 65.45, 65.45, 66.15, 67.54, 69.63, 69.63, 71.02, 72.41, 72.41,
    73.81, 74.5, 75.89, 75.89, 75.89, 77.29, 78.68, 78.68, 79.38, 79.38, 80.07,
    80.77, 81.46, 81.46, 82.86, 82.86, 82.16, 83.55, 83.55, 84.25, 84.95, 84.25,
    84.95, 85.64, 85.64, 84.25, 84.95, 86.34, 87.03, 87.03, 87.03, 87.03, 87.03,
    86.34, 88.43, 89.12, 87.73, 88.43, 87.73, 87.73, 87.73, 89.12, 87.73, 89.12,
    88.43, 88.43, 87.03, 88.43, 88.43, 87.03, 88.43, 89.82, 86.34, 87.73, 88.43,
    87.03, 89.82, 87.03, 90.52, 91.21, 89.12, 87.73, 89.12, 89.12, 87.73, 88.43,
    90.52, 89.82, 89.82, 88.43, 89.12, 89.12, 89.82, 89.12, 89.82, 89.82, 89.82,
    84.95, 87.73, 89.82, 89.82, 88.43, 90.52, 89.82, 87.03, 87.73, 89.12, 87.73,
    89.12, 89.12, 89.12, 90.52, 89.82, 89.12, 89.82, 89.82, 89.82, 88.43, 89.12,
    89.82, 90.52, 89.12, 89.12, 89.12, 89.12, 89.82, 89.12, 89.82, 89.82, 89.82,
    89.12, 89.12, 89.12, 89.12, 89.12, 89.12, 89.82, 89.12, 89.12, 89.12, 89.12,
    86.34, 89.12, 89.82, 89.82];

time = time.map(element => element*60/2960)
Velocity = Velocity.map(element => element*1/90)

app.use(cors());


const server = http.createServer(app);
const io = new Server(server, {
    cors: {
        origin: "http://localhost:3000"
    }
});


io.on("connection", (socket) => {
    //let i = 0;
    //socket.on("send_data", () => {
        //socket.broadcast.emit('start_sending')
    //});
    //socket.on("robot_sending", data => {
        //socket.broadcast.emit('robot_data', data)
    //})
    let i = 0;
    socket.on("send_data", () => {
        let IntervalId = setInterval(() => {
            socket.emit("reiceive_data", {time: time[i], velocity: Velocity[i]});
            i++;
            if(i >= time.length){
                clearInterval(IntervalId);
                i = 0;
                socket.emit("end");
            }
        }, 1000);
        
    });

    socket.on("setObjectif", setObjectif);
    socket.on("storeData", StoreData);
    socket.on("send_progression", () => {
        sendProgress().then(result => {
            console.log(result);
            socket.emit("emitProgress", result);
        }).catch(error => {
            console.error(error);
        })
    });
});

server.listen(3001, () => {
    console.log("server listening on port 3001")
});
